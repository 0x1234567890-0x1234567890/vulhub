# Neo4j Shell Server 反序列化漏洞（CVE-2021-34371）

Neo4j是一个开源图数据库管理系统。在3.4.x及以前版本中对外提供一个基于Java RMI协议通信的shell管理功能，该功能存在一处反序列化漏洞（非RMI协议反序列化，而是RMI的某个调用中存在反序列化），攻击者可以使用这个漏洞，借助Rhino利用链执行任意命令。

在Neo4j 3.5及之后的版本，Cyber Shell被Neo4j Shell替代。

参考链接：

- https://www.exploit-db.com/exploits/50170
- https://github.com/mozilla/rhino/issues/520

## 漏洞环境

如果你使用Linux或OSX系统，可以执行如下命令启动一个Neo4j 3.4.18：

```
TARGET_IP=<your-ip> docker-compose up -d
```

其中，环境变量`TARGET_IP`需要制定靶场环境的IP地址。

如果你是Windows系统，请直接修改`docker-compose.yml`，指定`TARGET_IP`环境变量的值。

服务启动后，访问`http://your-ip:7474`即可查看到Web管理页面，但我们需要攻击的是其1337端口，这个端口是Neo4j Shell端口，使用RMI协议通信。

## 漏洞复现

参考链接中的Java RMI客户端，集成基于Rhino的[Gadget](rhino_gadget/)，发送RMI请求：

![](1.png)

可见，`touch /tmp/success5`已成功执行：

![](2.png)
